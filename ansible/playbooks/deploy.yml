---
- hosts: controller
  tasks:
    - name: load ssh key
      shell: |
          ssh-add ~/.ssh/id_rsa

- hosts: webserver
  gather_facts: yes
  vars:
    NODEJS_VERSION: "8"
    mongodb_version: 4.0.10
    PROJECT_REPO: 'git@github.com:DevSquads/express-locallibrary-tutorial.git'
    PROJECT_NAME: 'Express-Library'
  tasks:
    - name: Install the gpg key for nodejs LTS
      apt_key:
        url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
        state: present

    - name: Install the nodejs LTS repos
      apt_repository:
        repo: "deb https://deb.nodesource.com/node_{{ NODEJS_VERSION }}.x {{ ansible_distribution_release }} main"
        state: present
        update_cache: yes

    - name: Install the nodejs
      apt:
        name: nodejs
        state: present

    - name: MongoDB | Import the public key used by the package management system
      apt_key:
          keyserver: keyserver.ubuntu.com
          id: 9DA31620334BD75D9DCB49F368818C72E52529D4
    - name: MongoDB | Create a list file
      lineinfile:
          dest: /etc/apt/sources.list.d/mongodb-org-4.0.list
          line: "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu {{ ansible_distribution_release }}/mongodb-org/4.0 multiverse"
          state: present
          create: yes
    - name: MongoDB | Install the packages
      apt:
          name:
            - mongodb-org={{ mongodb_version }}
            - mongodb-org-server={{ mongodb_version }}
            - mongodb-org-shell={{ mongodb_version }}
            - mongodb-org-mongos={{ mongodb_version }}
            - mongodb-org-tools={{ mongodb_version }}
          state: present
          update_cache: yes
      notify:
        - restart mongodb

    - name: install mongo systemd service (fix)
      when: ansible_distribution_release == "xenial"
      copy:
        src: ./templates/mongod.service.j2
        dest: /etc/systemd/system/mongod.service
    - name: MongoDB | Listen to all interfaces
      lineinfile:
          dest: /etc/mongod.conf
          regexp: '^  bindIp: 127.0.0.1'
          state: absent
      notify:
        - restart mongodb
    - name: Install GIT
      apt:
        name: git
        state: present
    - name: copy private key
      copy:
        src: /Users/Yahya/.ssh/id_rsa
        dest: ~/.ssh/id_rsa
        owner: root
        group: root
        mode: 0600

    - name: clone the toy project repo
      git:
        repo: '{{PROJECT_REPO}}'
        dest: $HOME/{{PROJECT_NAME}}
    - name:  DELETE private key
      file:
        path: $HOME/.ssh/id_rsa
        state: absent
  handlers:
    - name: restart mongodb
      service:
          name: mongod
          state: restarted